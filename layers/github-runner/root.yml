version: '3'

tasks:
  install:
    cmds:
      # Install GitHub Actions runner
      - |
        ARCH=$(uname -m)
        case "$ARCH" in
          x86_64) ;;
          *) echo "Unsupported architecture: $ARCH" >&2; exit 1;;
        esac
        VERSION=$(curl -s https://api.github.com/repos/actions/runner/releases/latest | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
        curl -fsSL "https://github.com/actions/runner/releases/download/v${VERSION}/actions-runner-linux-x64-${VERSION}.tar.gz" -o /tmp/actions-runner.tar.gz
        mkdir -p /opt/actions-runner
        tar xzf /tmp/actions-runner.tar.gz -C /opt/actions-runner
        rm /tmp/actions-runner.tar.gz
        cd /opt/actions-runner && ./bin/installdependencies.sh || true
        chmod +x /opt/actions-runner/run.sh /opt/actions-runner/config.sh

      # Install cosign
      - |
        ARCH=$(uname -m)
        case "$ARCH" in
          x86_64) ARCH=amd64;;
          aarch64) ARCH=arm64;;
          *) echo "Unsupported: $ARCH" >&2; exit 1;;
        esac
        curl -fsSL "https://github.com/sigstore/cosign/releases/download/v3.0.2/cosign-linux-${ARCH}" -o /usr/local/bin/cosign
        chmod 755 /usr/local/bin/cosign

      # Set file capabilities for rootless container support
      - setcap cap_setuid=ep /usr/bin/newuidmap
      - setcap cap_setgid=ep /usr/bin/newgidmap
