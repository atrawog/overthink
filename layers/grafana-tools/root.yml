# Grafana observability CLI tools
version: '3'

tasks:
  install:
    vars:
      MCP_GRAFANA_VERSION: "v0.7.8"
      K3D_VERSION: "v5.8.3"
    cmds:
      # mcp-grafana
      - |
        curl -fsSL "https://github.com/grafana/mcp-grafana/releases/download/{{.MCP_GRAFANA_VERSION}}/linux.x64.grafana.tar.gz" \
          -o /tmp/mcp-grafana.tar.gz
        mkdir -p /tmp/mcp-grafana-extract
        tar -xzf /tmp/mcp-grafana.tar.gz -C /tmp/mcp-grafana-extract/
        find /tmp/mcp-grafana-extract -name "mcp-grafana" -o -name "grafana" | head -1 | xargs -I{} mv {} /usr/local/bin/mcp-grafana
        chmod +x /usr/local/bin/mcp-grafana
        rm -rf /tmp/mcp-grafana.tar.gz /tmp/mcp-grafana-extract
      # logcli
      - |
        URL=$(curl -fsSL https://api.github.com/repos/grafana/loki/releases/latest | grep "browser_download_url.*logcli-linux-amd64.zip\"" | cut -d'"' -f4)
        curl -fsSL "$URL" -o /tmp/logcli.zip
        cd /tmp && unzip -q logcli.zip && mv logcli-linux-amd64 /usr/local/bin/logcli
        chmod +x /usr/local/bin/logcli && rm -f /tmp/logcli.zip
      # promtool
      - |
        VER=$(curl -fsSL https://api.github.com/repos/prometheus/prometheus/releases/latest | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
        curl -fsSL "https://github.com/prometheus/prometheus/releases/download/v${VER}/prometheus-${VER}.linux-amd64.tar.gz" -o /tmp/prom.tar.gz
        mkdir -p /tmp/prom && tar -xzf /tmp/prom.tar.gz -C /tmp/prom/ --strip-components=1
        mv /tmp/prom/promtool /usr/local/bin/promtool && chmod +x /usr/local/bin/promtool
        rm -rf /tmp/prom.tar.gz /tmp/prom
      # mimirtool
      - |
        URL=$(curl -fsSL https://api.github.com/repos/grafana/mimir/releases/latest | grep "browser_download_url.*mimir-linux-amd64\"" | grep -v ".sha256" | cut -d'"' -f4)
        curl -fsSL "$URL" -o /usr/local/bin/mimirtool && chmod +x /usr/local/bin/mimirtool
      # tempo-cli
      - |
        VER=$(curl -fsSL https://api.github.com/repos/grafana/tempo/releases/latest | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
        curl -fsSL "https://github.com/grafana/tempo/releases/download/v${VER}/tempo_${VER}_linux_amd64.tar.gz" -o /tmp/tempo.tar.gz
        mkdir -p /tmp/tempo && tar -xzf /tmp/tempo.tar.gz -C /tmp/tempo/
        find /tmp/tempo -name "tempo-cli" -o -name "tempo" | head -1 | xargs -I{} mv {} /usr/local/bin/tempo-cli
        chmod +x /usr/local/bin/tempo-cli && rm -rf /tmp/tempo.tar.gz /tmp/tempo
      # tanka (tk)
      - |
        curl -fsSL "https://github.com/grafana/tanka/releases/latest/download/tk-linux-amd64" -o /usr/local/bin/tk
        chmod +x /usr/local/bin/tk
      # grafanactl
      - |
        URL=$(curl -fsSL https://api.github.com/repos/grafana/grafanactl/releases/latest | grep "browser_download_url.*grafanactl_Linux_x86_64.tar.gz\"" | cut -d'"' -f4)
        curl -fsSL "$URL" -o /tmp/grafanactl.tar.gz
        mkdir -p /tmp/grafanactl && tar -xzf /tmp/grafanactl.tar.gz -C /tmp/grafanactl/
        find /tmp/grafanactl -name "grafanactl" | head -1 | xargs -I{} mv {} /usr/local/bin/grafanactl
        chmod +x /usr/local/bin/grafanactl && rm -rf /tmp/grafanactl.tar.gz /tmp/grafanactl
